<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioTech - Biblioteca Corporativa</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                <div class="logo-icon">üìö</div>
                <div>
                    <div class="logo-title">BiblioTech</div>
                    <div class="logo-subtitle">Biblioteca Corporativa</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-page="inicio">In√≠cio</a>
                <a href="#" class="nav-link" data-page="catalogo">Cat√°logo</a>
                <a href="#" class="nav-link" data-page="meus-livros">Meus Livros</a>
                <a href="#" class="nav-link" data-page="ranking">Ranking</a>
            </div>
            <div class="navbar-actions">
                <div class="points-badge" id="points-badge">
                    <span class="trophy-icon">üèÜ</span>
                    <span id="points-text">0 pts</span>
                </div>
                <div class="profile-icon" id="profile-icon">üë§</div>
                <div class="logout-icon" id="logout-icon" title="Sair">üö™</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome Banner -->
        <section class="welcome-banner" id="welcome-banner">
            <div class="welcome-content">
                <div class="welcome-header">
                    <span class="star-icon">‚≠ê</span>
                    <span class="welcome-label">BEM-VINDO DE VOLTA</span>
                </div>
                <h1 class="welcome-title">Ol√°, <span id="user-name">Usu√°rio</span>!</h1>
                <p class="welcome-text">Continue sua jornada de conhecimento. Cada livro lido te aproxima do topo do ranking!</p>
                <div class="welcome-actions">
                    <button class="btn-yellow" id="btn-explorar-catalogo">
                        Explorar Cat√°logo
                        <span class="arrow-icon">‚Üí</span>
                    </button>
                    <button class="btn-white-outline" id="btn-meus-livros">
                        Meus Livros
                    </button>
                </div>
            </div>
            <div class="welcome-decoration">üìñ</div>
        </section>

        <!-- Stats Cards -->
        <section class="stats-section">
            <div class="stat-card stat-orange">
                <div class="stat-header">
                    <span class="stat-label">Pontos Totais</span>
                    <span class="stat-icon">üèÜ</span>
                </div>
                <div class="stat-value" id="stat-pontos">0</div>
                <div class="stat-subtitle" id="stat-pontos-subtitle">Top 0% da empresa</div>
            </div>
            <div class="stat-card stat-blue">
                <div class="stat-header">
                    <span class="stat-label">Livros Lidos</span>
                    <span class="stat-icon">üìö</span>
                </div>
                <div class="stat-value" id="stat-livros-lidos">0</div>
                <div class="stat-subtitle">Este m√™s</div>
            </div>
            <div class="stat-card stat-white">
                <div class="stat-header">
                    <span class="stat-label">Sequ√™ncia</span>
                    <span class="stat-icon">üî•</span>
                </div>
                <div class="stat-value" id="stat-sequencia">0 dias</div>
                <div class="stat-subtitle">Continue lendo!</div>
            </div>
            <div class="stat-card stat-white">
                <div class="stat-header">
                    <span class="stat-label">Empr√©stimos</span>
                    <span class="stat-icon">‚è∞</span>
                </div>
                <div class="stat-value" id="stat-emprestimos">0</div>
                <div class="stat-subtitle">Livros com voc√™</div>
            </div>
        </section>

        <!-- Next Return Banner -->
        <section class="return-banner hidden" id="return-banner">
            <div class="return-info">
                <span class="return-label">Devolu√ß√£o Pr√≥xima</span>
                <span class="return-text" id="return-text">Nenhum livro para devolver</span>
            </div>
            <button class="btn-yellow-small" id="btn-devolver">Devolver Livro</button>
        </section>

        <!-- Featured Books -->
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">Livros em Destaque</h2>
                <a href="#" class="section-link" id="link-ver-todos">Ver todos ‚Üí</a>
            </div>
            <div class="books-grid" id="featured-books">
                <!-- Livros em destaque ser√£o inseridos aqui -->
            </div>
        </section>

        <!-- Top Readers -->
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">Top Leitores</h2>
                <a href="#" class="section-link" id="link-ver-ranking">Ver ranking ‚Üí</a>
            </div>
            <div class="top-readers" id="top-readers">
                <!-- Top leitores ser√£o inseridos aqui -->
            </div>
        </section>

        <!-- Achievements -->
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">Suas Conquistas</h2>
            </div>
            <div class="achievements" id="achievements">
                <!-- Conquistas ser√£o inseridas aqui -->
            </div>
        </section>

        <!-- Catalog Page (hidden by default) -->
        <section class="catalog-page hidden" id="catalog-page">
            <div class="catalog-header">
                <h2 class="section-title">Cat√°logo de Livros</h2>
                <div class="catalog-actions">
                    <input type="text" id="filtro-busca" placeholder="Buscar livro ou autor..." class="search-input">
                    <button class="btn-secondary" id="btn-atualizar">Atualizar</button>
                </div>
            </div>
            <div class="books-catalog" id="books-catalog">
                <!-- Cat√°logo completo ser√° inserido aqui -->
            </div>
        </section>

        <!-- My Books Page (hidden by default) -->
        <section class="my-books-page hidden" id="my-books-page">
            <h2 class="section-title">Meus Livros</h2>
            <div class="stack">
                <div>
                    <label for="emp-livro-id">Livro ID</label>
                    <input id="emp-livro-id" placeholder="ID do livro">
                </div>
                <button class="btn-primary" id="btn-emprestar">Solicitar empr√©stimo</button>
            </div>

            <div class="stack" style="margin-top:20px;">
                <label for="dev-livro-id">Finalizar empr√©stimo (gamifica√ß√£o)</label>
                <input id="dev-livro-id" placeholder="ID do livro devolvido">
                <button class="btn-secondary" id="btn-carregar-perguntas">Carregar perguntas do livro</button>
                <div id="perguntas-container" style="margin-top:10px;"></div>
                <textarea id="dev-respostas" rows="3" placeholder="Respostas das perguntas (uma por linha ou separadas por v√≠rgula)"></textarea>
                <button class="btn-secondary" id="btn-finalizar">Enviar devolu√ß√£o e responder quiz</button>
            </div>
        </section>

        <!-- Ranking Page (hidden by default) -->
        <section class="ranking-page hidden" id="ranking-page">
            <h2 class="section-title">Ranking de Leitores</h2>
            <div class="ranking-list" id="ranking-list">
                <!-- Ranking ser√° inserido aqui -->
            </div>
        </section>
    </main>

    <div id="toast" class="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="common.js"></script>
    <script>
        let currentPage = 'inicio';
        let userData = { nome: '', pontos: 0, nivel: 1, role: 'user' };

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.dataset.page;
                showPage(page);
            });
        });

        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.getElementById('welcome-banner').classList.toggle('hidden', page !== 'inicio');
            document.getElementById('catalog-page').classList.toggle('hidden', page !== 'catalogo');
            document.getElementById('my-books-page').classList.toggle('hidden', page !== 'meus-livros');
            document.getElementById('ranking-page').classList.toggle('hidden', page !== 'ranking');
            
            if (page === 'catalogo') {
                renderCatalog();
            } else if (page === 'ranking') {
                renderRanking();
            }
        }

        document.getElementById('btn-explorar-catalogo').onclick = () => showPage('catalogo');
        document.getElementById('btn-meus-livros').onclick = () => showPage('meus-livros');
        document.getElementById('link-ver-todos').onclick = (e) => { e.preventDefault(); showPage('catalogo'); };
        document.getElementById('link-ver-ranking').onclick = (e) => { e.preventDefault(); showPage('ranking'); };
        document.getElementById('btn-devolver').onclick = () => showPage('meus-livros');

        // Render functions
        function renderFeaturedBooks() {
            const container = document.getElementById('featured-books');
            const featured = state.livros.slice(0, 4);
            container.innerHTML = '';
            
            featured.forEach(livro => {
                const card = document.createElement('div');
                card.className = 'book-card-featured';
                card.innerHTML = `
                    <div class="book-image-placeholder">üìñ</div>
                    <div class="book-info">
                        <div class="book-status ${livro.disponivel ? 'available' : 'unavailable'}">${livro.disponivel ? 'Dispon√≠vel' : 'Emprestado'}</div>
                        <h3 class="book-title">${livro.titulo || 'Sem t√≠tulo'}</h3>
                        <p class="book-author">${livro.autor || 'Autor desconhecido'}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderCatalog() {
            const container = document.getElementById('books-catalog');
            const filtro = document.getElementById('filtro-busca').value?.toLowerCase() || '';
            const filtered = state.livros.filter(l => 
                l.titulo?.toLowerCase().includes(filtro) || 
                l.autor?.toLowerCase().includes(filtro)
            );
            
            container.innerHTML = '';
            filtered.forEach(livro => {
                const card = document.createElement('div');
                card.className = 'book-card-catalog';
                card.innerHTML = `
                    <div class="book-image-placeholder-catalog">üìñ</div>
                    <div class="book-overlay">
                        <div class="book-status ${livro.disponivel ? 'available' : 'unavailable'}">${livro.disponivel ? 'Dispon√≠vel' : 'Emprestado'}</div>
                        <h3 class="book-title-catalog">${livro.titulo || 'Sem t√≠tulo'}</h3>
                        <p class="book-author-catalog">${livro.autor || 'Autor desconhecido'}</p>
                        <button class="btn-yellow-small" data-livro="${livro.id}" ${!livro.disponivel ? 'disabled' : ''}>Ver Detalhes</button>
                    </div>
                `;
                container.appendChild(card);
            });

            container.querySelectorAll('button[data-livro]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const livroId = e.target.dataset.livro;
                    const livro = state.livros.find(l => l.id === livroId);
                    if (livro?.disponivel) {
                        await registrarEmprestimo(state.user.email, livroId);
                        toast("Empr√©stimo solicitado!");
                        await buscarLivros();
                        renderCatalog();
                        renderFeaturedBooks();
                    } else {
                        toast("Livro indispon√≠vel", "error");
                    }
                });
            });
        }

        async function renderTopReaders() {
            try {
                const ranking = await buscarRanking();
                const top3 = ranking.slice(0, 3);
                const container = document.getElementById('top-readers');
                container.innerHTML = '';
                
                top3.forEach((user, index) => {
                    const isCurrentUser = user.email === state.user.email;
                    const card = document.createElement('div');
                    card.className = `reader-card ${isCurrentUser ? 'current-user' : ''}`;
                    card.innerHTML = `
                        <div class="reader-avatar">${user.nome ? user.nome.charAt(0).toUpperCase() : 'üë§'}</div>
                        <div class="reader-info">
                            <div class="reader-name">${user.nome || user.email.split('@')[0]} ${isCurrentUser ? '(voc√™)' : ''}</div>
                            <div class="reader-role">${user.role === 'admin' ? 'Admin' : 'Usu√°rio'}</div>
                        </div>
                        <div class="reader-stats">
                            <span class="reader-stat">üî• ${user.nivel || 1}</span>
                            <span class="reader-stat points">${user.pontos} pts</span>
                            <span class="reader-stat">${Math.floor((user.pontos || 0) / 50) || 0} livros</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                console.error('Erro ao carregar top leitores:', err);
            }
        }

        async function renderRanking() {
            try {
                const ranking = await buscarRanking();
                const container = document.getElementById('ranking-list');
                container.innerHTML = '';
                
                ranking.forEach((user, index) => {
                    const isCurrentUser = user.email === state.user.email;
                    const card = document.createElement('div');
                    card.className = `ranking-item ${isCurrentUser ? 'current-user' : ''}`;
                    card.innerHTML = `
                        <div class="ranking-position">${index + 1}¬∫</div>
                        <div class="ranking-avatar">${user.nome ? user.nome.charAt(0).toUpperCase() : 'üë§'}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${user.nome || user.email.split('@')[0]} ${isCurrentUser ? '(voc√™)' : ''}</div>
                            <div class="ranking-role">${user.role === 'admin' ? 'Admin' : 'Usu√°rio'}</div>
                        </div>
                        <div class="ranking-stats">
                            <span class="ranking-points">${user.pontos} pts</span>
                            <span class="ranking-level">N√≠vel ${user.nivel}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                console.error('Erro ao carregar ranking:', err);
            }
        }

        async function updateStats(roleData) {
            userData = roleData;
            document.getElementById('stat-pontos').textContent = roleData.pontos || 0;
            document.getElementById('points-text').textContent = `${roleData.pontos || 0} pts`;
            
            // Calcular percentil baseado no ranking
            try {
                const ranking = await buscarRanking();
                const userIndex = ranking.findIndex(u => u.email === state.user.email);
                const totalUsers = ranking.length || 1;
                const percentile = userIndex >= 0 ? Math.max(1, Math.floor(((totalUsers - userIndex) / totalUsers) * 100)) : 50;
                document.getElementById('stat-pontos-subtitle').textContent = `Top ${percentile}% da empresa`;
            } catch (err) {
                document.getElementById('stat-pontos-subtitle').textContent = 'Top 50% da empresa';
            }
            
            // Calcular livros lidos (baseado em respostas corretas ou empr√©stimos finalizados)
            // Por enquanto, usar uma estimativa baseada em pontos
            const livrosLidos = Math.floor((roleData.pontos || 0) / 50) || 0;
            document.getElementById('stat-livros-lidos').textContent = livrosLidos;
            
            // Calcular empr√©stimos ativos (livros n√£o dispon√≠veis que o usu√°rio pode ter)
            const emprestimosAtivos = state.livros.filter(l => !l.disponivel).length || 0;
            document.getElementById('stat-emprestimos').textContent = emprestimosAtivos;
            
            // Mostrar banner de devolu√ß√£o se houver empr√©stimos
            if (emprestimosAtivos > 0) {
                const primeiroEmprestimo = state.livros.find(l => !l.disponivel);
                if (primeiroEmprestimo) {
                    document.getElementById('return-text').textContent = `${primeiroEmprestimo.titulo} - Devolu√ß√£o em breve`;
                    document.getElementById('return-banner').classList.remove('hidden');
                }
            } else {
                document.getElementById('return-banner').classList.add('hidden');
            }
            
            // Atualizar conquistas
            updateAchievements(roleData);
        }
        
        function updateAchievements(roleData) {
            const container = document.getElementById('achievements');
            const achievements = [];
            
            if (roleData.pontos >= 10) {
                achievements.push({ icon: 'üéØ', name: 'Primeiro Passo' });
            }
            if (roleData.pontos >= 100) {
                achievements.push({ icon: '‚≠ê', name: 'Leitor Iniciante' });
            }
            if (roleData.pontos >= 500) {
                achievements.push({ icon: 'üèÜ', name: 'Leitor Avan√ßado' });
            }
            if (roleData.nivel >= 5) {
                achievements.push({ icon: 'üëë', name: 'Mestre Leitor' });
            }
            
            if (achievements.length === 0) {
                container.innerHTML = '<p class="muted">Continue lendo para desbloquear conquistas!</p>';
            } else {
                container.innerHTML = achievements.map(a => `
                    <div class="achievement-badge">
                        <span class="achievement-icon">${a.icon}</span>
                        <span class="achievement-name">${a.name}</span>
                    </div>
                `).join('');
            }
        }

        // Event handlers
        document.getElementById('btn-atualizar').onclick = async () => {
            await buscarLivros();
            renderCatalog();
            renderFeaturedBooks();
        };
        document.getElementById('filtro-busca').oninput = renderCatalog;

        document.getElementById('btn-emprestar').onclick = async () => {
            const livroId = document.getElementById('emp-livro-id').value;
            if (!livroId) return toast("Informe o ID do livro", "error");
            const livro = state.livros.find(l => l.id === livroId);
            if (!livro?.disponivel) return toast("Livro indispon√≠vel", "error");
            await registrarEmprestimo(state.user.email, livroId);
            toast("Empr√©stimo solicitado");
        };

        document.getElementById('btn-carregar-perguntas').onclick = async () => {
            const livroId = document.getElementById('dev-livro-id').value;
            if (!livroId) return toast("Informe o ID do livro", "error");
            
            try {
                const perguntas = await listarPerguntasLivro(livroId);
                const container = document.getElementById('perguntas-container');
                
                if (perguntas.length === 0) {
                    container.innerHTML = "<p class='muted'>Este livro n√£o possui perguntas cadastradas.</p>";
                    return;
                }
                
                let html = "<div class='stack' style='background:var(--bg-secondary);padding:10px;border-radius:4px;'>";
                html += "<strong>Perguntas do Quiz:</strong>";
                perguntas.forEach((p, i) => {
                    html += `<div style='margin-top:8px;'><strong>${i + 1}.</strong> ${p[2]} <span class='badge badge-success' style='font-size:0.8em;'>${p[4]} pts</span></div>`;
                });
                html += "</div>";
                container.innerHTML = html;
                
            } catch (err) {
                toast("Erro ao carregar perguntas: " + err.message, "error");
            }
        };

        document.getElementById('btn-finalizar').onclick = async () => {
            const livroId = document.getElementById('dev-livro-id').value;
            if (!livroId) return toast("Informe o ID do livro", "error");
            
            try {
                const perguntas = await listarPerguntasLivro(livroId);
                
                if (perguntas.length === 0) {
                    await finalizarEmprestimo(state.user.email, livroId);
                    toast("Devolu√ß√£o registrada!");
                    document.getElementById('dev-livro-id').value = "";
                    document.getElementById('dev-respostas').value = "";
                    document.getElementById('perguntas-container').innerHTML = "";
                    return;
                }
                
                const respostasTexto = document.getElementById('dev-respostas').value.trim();
                if (!respostasTexto) {
                    return toast("Responda as perguntas do quiz antes de finalizar", "error");
                }
                
                const respostasArray = respostasTexto.split(/\n|,/).map(r => r.trim()).filter(r => r);
                
                if (respostasArray.length < perguntas.length) {
                    return toast(`Voc√™ precisa responder todas as ${perguntas.length} perguntas`, "error");
                }
                
                let totalPontos = 0;
                let perguntasCorretas = 0;
                
                for (let i = 0; i < perguntas.length && i < respostasArray.length; i++) {
                    const pergunta = perguntas[i];
                    const resposta = respostasArray[i];
                    
                    const resultado = await responderPergunta({
                        email: state.user.email,
                        livroId: livroId,
                        perguntaId: pergunta[0],
                        resposta: resposta
                    });
                    
                    if (resultado.correta === "sim") {
                        totalPontos += resultado.pontos || 0;
                        perguntasCorretas++;
                    }
                }
                
                await finalizarEmprestimo(state.user.email, livroId);
                
                const roleData = await fetchRole(state.user.email);
                state.role = roleData.role;
                await updateStats(roleData);
                await buscarLivros();
                renderFeaturedBooks();
                
                toast(`Devolu√ß√£o registrada! ${perguntasCorretas}/${perguntas.length} corretas. Voc√™ ganhou ${totalPontos} pontos! Total: ${roleData.pontos} pontos (N√≠vel ${roleData.nivel})`);
                document.getElementById('dev-livro-id').value = "";
                document.getElementById('dev-respostas').value = "";
                document.getElementById('perguntas-container').innerHTML = "";
                
            } catch (err) {
                toast("Erro ao finalizar empr√©stimo: " + err.message, "error");
            }
        };

        document.getElementById('logout-icon').onclick = () => auth.signOut();

        // Auth state
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            state.user = user;
            const roleData = await fetchRole(user.email);
            state.role = roleData.role;
            
            if (roleData.role === "admin") {
                window.location.href = "admin.html";
                return;
            }
            
            // Buscar nome do usu√°rio
            const nomeUsuario = await buscarNomeUsuario(user.email);
            document.getElementById('user-name').textContent = nomeUsuario;
            userData.nome = nomeUsuario;
            
            await buscarLivros();
            await updateStats(roleData);
            renderFeaturedBooks();
            await renderTopReaders();
        });
    </script>
</body>
</html>
